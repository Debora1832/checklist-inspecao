<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checklist — Compacto (corrigido)</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{background:#f5f7fa;color:#222;padding:18px}
    .page{max-width:1100px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 8px 24px rgba(15,20,40,.06)}
    .hidden{display:none!important}label{display:block;margin:10px 0 6px;font-weight:700}
    input,select,textarea{padding:8px;border:1px solid #d1d7e0;border-radius:6px;font-size:14px}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .primary{background:#0b72d1;color:#fff}.secondary{background:#edf2f7;color:#111;border:1px solid #e2e8f0}
    .icon{width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px}
    .thumb{width:80px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #e6eef9;background:#eef4fb}
    .row{display:flex;gap:12px;align-items:center}
    .item-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 0}
    .item-card{margin-bottom:10px;border:1px solid #e6eef9;border-radius:8px;padding:10px;display:flex;gap:12px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal{background:#fff;padding:12px;border-radius:8px;max-width:720px;width:100%}
    .cond{display:none;margin-top:8px}.cond.visible{display:block}
    .bar-chart{display:flex;gap:8px;align-items:flex-end;height:140px;padding:8px;border:1px solid #e6eef9;border-radius:8px;background:#fbfdff}
    .bar{flex:1;display:flex;flex-direction:column;align-items:center}
    .fill{width:34px;border-radius:4px 4px 0 0;background:#0b72d1}
  </style>
</head>
<body>
<header style="max-width:1200px;margin:0 auto 12px;display:flex;justify-content:space-between;align-items:center">
  <div style="font-size:20px;color:#0b2a63;font-weight:800">Checklist de Inspeção</div>
  <div style="display:flex;gap:8px"><button id="open-report-btn" class="btn secondary">Relatórios</button><button id="open-admin-btn" class="btn secondary">Admin</button></div>
</header>

<section id="page-index" class="page">
  <label>Inspetor</label>
  <select id="inspector-select"><option value="">-- selecione --</option></select>
  <label>Peça</label>
  <select id="part-select"><option value="">-- selecione --</option></select>
  <div style="margin-top:12px"><button id="start-checklist-btn" class="btn primary">Iniciar Checklist</button></div>
</section>

<section id="page-admin" class="page hidden">
  <div class="row" style="justify-content:space-between"><h3>Admin</h3><button id="admin-back-btn" class="btn secondary">Voltar</button></div>
  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
    <div style="flex:1;min-width:260px">
      <label>Código</label><input id="new-piece-code" placeholder="Ex: 597-2445#01">
      <label>Descrição</label><input id="new-piece-desc" placeholder="Longarina">
      <label>Imagem (obrigatória)</label><input id="new-piece-model" type="file" accept="image/*">
      <div style="margin-top:8px"><button id="save-piece-btn" class="btn primary">Adicionar peça</button><button id="clear-piece-form-btn" class="btn secondary" style="margin-left:8px">Limpar</button></div>
      <h4 style="margin-top:12px">Peças existentes</h4><ul id="existing-pieces-list" style="padding-left:18px"></ul>
    </div>

    <div style="flex:1;min-width:260px">
      <label>Selecionar peça</label><select id="admin-piece-select"></select>
      <h4 style="margin-top:8px">Itens atuais</h4><ul id="admin-current-items" style="padding-left:18px"></ul>
      <label style="margin-top:8px">Novo item</label><input id="admin-new-item" placeholder="Dimensão X">
      <label>Descrição do item (obrigatória)</label><textarea id="admin-new-item-detail" style="width:100%;min-height:60px"></textarea>
      <label>Imagem do item (obrigatória)</label><input id="admin-new-item-img" type="file" accept="image/*">
      <div style="margin-top:8px"><button id="admin-add-item-btn" class="btn secondary">Adicionar item</button></div>
    </div>

    <div style="flex:0 0 260px">
      <label>Adicionar Inspetor</label><input id="new-inspector-name" placeholder="Nome do inspetor">
      <div style="margin-top:8px"><button id="add-inspector-btn" class="btn primary">Adicionar</button><button id="clear-inspector-btn" class="btn secondary" style="margin-left:8px">Limpar</button></div>
      <h4 style="margin-top:12px">Inspetores</h4><ul id="inspectors-list" style="padding-left:18px"></ul>
    </div>
  </div>
</section>

<section id="page-checklist" class="page hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 id="piece-title"></h3><button id="checklist-back-btn" class="btn secondary">Voltar</button></div>
  <img id="piece-image" style="max-width:320px;border-radius:8px;border:1px solid #e6eef9;background:#eef4fb;margin-bottom:8px;display:block;height:auto" alt="Imagem">
  <label>Descrição detalhada da inspeção</label><textarea id="inspection-detail" style="width:100%;height:80px"></textarea>
  <div id="checklist-container" style="margin-top:12px"></div>
  <div style="margin-top:12px"><button id="save-all-btn" class="btn primary">Salvar Checklist</button></div>
</section>

<section id="page-report" class="page hidden">
  <div style="display:flex;justify-content:space-between;align-items:center"><h3>Relatórios</h3><button id="report-back-btn" class="btn secondary">Voltar</button></div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:8px"><button id="export-csv-btn" class="btn secondary">Exportar CSV</button><div id="report-summary-box" style="margin-left:8px;padding:8px;border-radius:6px;background:#eef7ff;color:#0b3d91">Totais: —</div></div>
  <h4 style="margin-top:12px">Volume mensal</h4><div id="report-chart" class="bar-chart"></div>
  <h4 style="margin-top:12px">Histórico</h4><table id="report-table" style="width:100%;border-collapse:collapse"><thead><tr><th>Data</th><th>Inspetor</th><th>Peça</th><th>Descrição</th></tr></thead><tbody></tbody></table>
</section>

<!-- modals -->
<div id="modal-backdrop" class="modal-backdrop" aria-hidden="true"><div class="modal"><h3>Editar item</h3><label>Descrição</label><input id="modal-item-desc"><label style="margin-top:8px">Substituir imagem</label><input id="modal-item-file" type="file" accept="image/*"><div style="margin-top:8px"><img id="modal-img-preview" style="width:200px;height:140px;object-fit:cover;border-radius:6px;background:#eef4fb"></div><div style="margin-top:8px;text-align:right"><button id="modal-cancel" class="btn secondary">Cancelar</button><button id="modal-save" class="btn primary" style="margin-left:8px">Salvar</button></div></div></div>
<div id="modal-delete-backdrop" class="modal-backdrop" aria-hidden="true"><div class="modal"><h3>Confirmar Exclusão</h3><p id="modal-delete-text">Deseja remover este item?</p><div style="margin-top:8px;text-align:right"><button id="modal-delete-cancel" class="btn secondary">Cancelar</button><button id="modal-delete-confirm" class="btn primary" style="margin-left:8px">Confirmar</button></div></div></div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const pieces = {};
  const defaultItems = [{id:1,description:'Verificar alinhamento da face de contato, tolerância 0.5mm'},{id:2,description:'Inspecionar solda do flange: sem porosidade'}];
  let history = JSON.parse(localStorage.getItem('inspectionsHistory_v1')||'[]');
  let inspectors = [{id:'ins_1',name:'João Silva'},{id:'ins_2',name:'Maria Santos'}];

  const makeSVG=(t,w=320,h=240)=>'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="'+w+'" height="'+h+'"><rect width="100%" height="100%" fill="#eef4fb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#93a6bf" font-family="Arial" font-size="14">'+t+'</text></svg>');
  const persist=()=>localStorage.setItem('inspectionsHistory_v1',JSON.stringify(history));
  const clear=(n)=>{while(n&&n.firstChild) n.removeChild(n.firstChild);} 

  function fillPieceOptions(){ const sel=$('admin-piece-select'), main=$('part-select'), ul=$('existing-pieces-list'); if(!sel||!main||!ul) return; sel.innerHTML=''; main.innerHTML='<option value="">-- selecione --</option>'; clear(ul); for(const k in pieces){ const p=pieces[k]; const li=document.createElement('li'); li.className='item-row'; li.innerHTML='<div class="row"><img class="thumb" src="'+(p.modelImage||makeSVG('Sem imagem',80,60))+'" onerror="this.src=\''+makeSVG('Sem imagem',80,60)+'\'"> <span>'+(k+(p.description? ' — '+p.description:''))+'</span></div>'; const controls=document.createElement('div'); controls.innerHTML='<button class="icon" title="Editar">✏️</button><button class="icon" title="Excluir">✖</button>'; controls.children[0].addEventListener('click',()=>openEditPiece(k)); controls.children[1].addEventListener('click',()=>openDelete(k,null,'piece')); li.appendChild(controls); ul.appendChild(li); const o=document.createElement('option'); o.value=k; o.textContent=k+(p.description? ' — '+p.description:''); sel.appendChild(o); main.appendChild(o.cloneNode(true)); }
    if(!sel.children.length){ const o=document.createElement('option'); o.textContent='-- nenhuma peça cadastrada --'; o.disabled=true; sel.appendChild(o); }
  }

  function fillInspectors(){ const ul=$('inspectors-list'), sel=$('inspector-select'); if(!ul||!sel) return; clear(ul); sel.innerHTML='<option value="">-- selecione --</option>'; inspectors.forEach(i=>{ const li=document.createElement('li'); li.className='item-row'; li.innerHTML='<span>'+i.name+'</span><div><button class="icon">✖</button></div>'; li.querySelector('button').addEventListener('click',()=>{ if(confirm('Excluir este inspetor?')){ inspectors=inspectors.filter(x=>x.id!==i.id); fillInspectors(); }}); ul.appendChild(li); const o=document.createElement('option'); o.value=i.name; o.textContent=i.name; sel.appendChild(o); }); }

  function openEditPiece(code){ const p=pieces[code]; if(!p) return alert('Peça não encontrada'); $('modal-item-desc').value=''; $('modal-img-preview').src = p.modelImage||makeSVG('Sem imagem',200,140); $('modal-backdrop').style.display='flex'; $('modal-backdrop').dataset.editPiece=code; }
  function openDelete(code,idx,type){ $('modal-delete-text').textContent = type==='item' ? 'Deseja remover este item?' : 'Deseja remover esta peça e todos os itens?'; $('modal-delete-backdrop').style.display='flex'; $('modal-delete-backdrop').dataset.code=code||''; $('modal-delete-backdrop').dataset.idx = (typeof idx==='number')? idx : ''; $('modal-delete-backdrop').dataset.type=type; }

  function renderChecklist(items,saved){ const cont=$('checklist-container'); clear(cont); items.forEach((it,idx)=>{ const card=document.createElement('div'); card.className='item-card'; card.innerHTML='<img class="thumb" src="'+(it.image||makeSVG('Sem imagem',320,240))+'" onerror="this.src=\''+makeSVG('Sem imagem',320,240)+'\'"><div style="flex:1"><div style="font-weight:600">'+(it.description||'')+'</div><div style="color:#374151">'+(it.detail||'')+'</div></div><div style="display:flex;flex-direction:column;gap:6px;justify-content:flex-end"><button class="btn">OK</button><button class="btn">Não OK</button></div>'; cont.appendChild(card); const ok=card.querySelectorAll('button')[0], nok=card.querySelectorAll('button')[1]; ok.onclick=()=>{card.classList.add('ok');card.classList.remove('not-ok');}; nok.onclick=()=>{card.classList.add('not-ok');card.classList.remove('ok');}; if(saved && Array.isArray(saved) && saved[idx]){ const s=saved[idx]; if(s.status==='OK') ok.click(); else if(s.status==='Não OK') nok.click(); } }); }

  function showChecklist(inspector,piece){ if(!inspector||!piece) return alert('Escolha Inspetor e Peça'); $('piece-title').textContent=piece; const p=pieces[piece]||null; $('piece-image').src = p && p.modelImage ? p.modelImage : makeSVG(piece); $('inspection-detail').value = p && p.description ? p.description : ''; const saved = history.slice().reverse().find(r=>r.inspector===inspector && r.piece===piece); renderChecklist(p&&p.items&&p.items.length? p.items : defaultItems, saved? saved.data : null); $('page-index').classList.add('hidden'); $('page-admin').classList.add('hidden'); $('page-report').classList.add('hidden'); $('page-checklist').classList.remove('hidden'); }

  function collect(){ return Array.from(document.querySelectorAll('.item-card')).map((c,i)=>{ const status = c.classList.contains('not-ok')? 'Não OK' : (c.classList.contains('ok')? 'OK' : 'Sem marcação'); return {index:i+1, description: c.querySelector('div').innerText.trim(), status}; }); }

  function renderReport(){ const tbody=document.querySelector('#report-table tbody'); const chart=$('report-chart'); clear(tbody); chart.innerHTML=''; if(!history.length){ chart.textContent='(Sem lançamentos)'; $('report-summary-box').textContent='Totais: 0'; return; } const counts={}; history.forEach(r=>{ const month=(r.date||new Date().toISOString().slice(0,10)).slice(0,7); counts[month]=(counts[month]||0)+1; const tr=document.createElement('tr'); tr.style.cursor='pointer'; ['date','inspector','piece','inspectionDetail'].forEach(k=>{ const td=document.createElement('td'); td.textContent = r[k]||''; tr.appendChild(td); }); tr.addEventListener('click',()=>{ $('inspector-select').value=r.inspector; $('part-select').value=r.piece; showChecklist(r.inspector,r.piece); }); tbody.appendChild(tr); }); const months=Object.keys(counts).sort(); const max=Math.max(...Object.values(counts)); months.forEach(m=>{ const bar=document.createElement('div'); bar.className='bar'; const fill=document.createElement('div'); fill.className='fill'; fill.style.height = (max? Math.round((counts[m]/max)*100)+20:20)+'px'; const lbl=document.createElement('div'); lbl.style.fontSize='12px'; lbl.style.marginTop='6px'; lbl.textContent=m; bar.appendChild(fill); bar.appendChild(lbl); chart.appendChild(bar); }); $('report-summary-box').textContent = months[months.length-1] + ' — ' + (counts[months[months.length-1]]||0) + ' lanç.'; }

  function downloadCSV(){ if(!history.length) return alert('Nenhum registro para exportar'); const h=['date','inspector','piece','inspectionDetail','items']; const rows=[h.join(',')]; history.forEach(r=>{ const items=JSON.stringify(r.data||[]); const row=[r.date||'',r.inspector||'',r.piece||'',r.inspectionDetail||'',items].map(v=>'"'+String(v).replace(/"/g,'""')+'"'); rows.push(row.join(',')); }); const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inspections_history.csv'; document.body.appendChild(a); a.click(); a.remove(); }

  // events setup
  document.addEventListener('DOMContentLoaded',()=>{
    // seed
    pieces['597-2445#01']={modelImage:null,description:'Longarina',items:[{description:'Dimensão A (Ø)'},{description:'Furo B posição'},{description:'Solda - qualidade'}]};
    pieces['597-2435#01']={modelImage:null,description:'Longarina',items:[]};

    fillPieceOptions(); fillInspectors(); renderReport();

    $('open-admin-btn').onclick=()=>{ $('page-index').classList.add('hidden'); $('page-admin').classList.remove('hidden'); };
    $('admin-back-btn').onclick=()=>{ $('page-admin').classList.add('hidden'); $('page-index').classList.remove('hidden'); };
    $('open-report-btn').onclick=()=>{ $('page-index').classList.add('hidden'); $('page-report').classList.remove('hidden'); renderReport(); };
    $('report-back-btn').onclick=()=>{ $('page-report').classList.add('hidden'); $('page-index').classList.remove('hidden'); };
    $('start-checklist-btn').onclick=()=> showChecklist($('inspector-select').value,$('part-select').value);
    $('save-piece-btn').onclick=async()=>{ const code=$('new-piece-code').value.trim(); if(!code) return alert('Digite o código'); const f=$('new-piece-model').files[0]; if(!f) return alert('Imagem modelo obrigatória'); const fr=new FileReader(); fr.onload=()=>{ pieces[code]={modelImage:fr.result,description:$('new-piece-desc').value.trim()||'',items:[]}; fillPieceOptions(); $('new-piece-code').value=''; $('new-piece-desc').value=''; $('new-piece-model').value=''; alert('Peça adicionada.'); }; fr.readAsDataURL(f); };
    $('admin-add-item-btn').onclick=async()=>{ const code=$('admin-piece-select').value; if(!code) return alert('Selecione peça'); const txt=$('admin-new-item').value.trim(); const f=$('admin-new-item-img').files[0]; const detail=$('admin-new-item-detail').value.trim(); if(!txt) return alert('Digite o item'); if(!f) return alert('Imagem do item obrigatória'); if(!detail) return alert('A descrição do item é obrigatória ao adicionar.'); const fr=new FileReader(); fr.onload=()=>{ pieces[code].items.push({description:txt,image:fr.result,detail}); $('admin-new-item').value=''; $('admin-new-item-img').value=''; $('admin-new-item-detail').value=''; fillPieceOptions(); fillInspectors(); }; fr.readAsDataURL(f); };
    $('add-inspector-btn').onclick=()=>{ const n=$('new-inspector-name').value.trim(); if(!n) return alert('Digite um nome'); inspectors.push({id:'ins_'+Date.now(),name:n}); $('new-inspector-name').value=''; fillInspectors(); };
    $('save-all-btn').onclick=()=>{ const sum=collect(); const hasNok=sum.some(s=>s.status==='Não OK'); const det=$('inspection-detail').value.trim(); if(hasNok && !det) return alert('Quando houver itens Não OK, a descrição detalhada da inspeção é obrigatória.'); const rec={date:(new Date()).toISOString().slice(0,10),inspector:$('inspector-select').value||'',piece:$('piece-title').textContent||'',data:sum,inspectionDetail:det}; const found=history.findIndex(h=>h.inspector===rec.inspector&&h.piece===rec.piece); if(found>-1) history[found]=rec; else history.push(rec); persist(); alert('Checklist salvo'); $('page-checklist').classList.add('hidden'); $('page-index').classList.remove('hidden'); renderReport(); };
    $('export-csv-btn').onclick=downloadCSV;

    $('modal-cancel').onclick=()=>{$('modal-backdrop').style.display='none';};
    $('modal-delete-cancel').onclick=()=>{$('modal-delete-backdrop').style.display='none';};
    $('modal-delete-confirm').onclick=()=>{ const code=$('modal-delete-backdrop').dataset.code; const idx=$('modal-delete-backdrop').dataset.idx; const type=$('modal-delete-backdrop').dataset.type; if(type==='item'){ if(code && idx!=='') pieces[code].items.splice(Number(idx),1); } else if(type==='piece'){ if(code) delete pieces[code]; } $('modal-delete-backdrop').style.display='none'; fillPieceOptions(); };

    // backdrop close
    Array.from(document.querySelectorAll('.modal-backdrop')).forEach(bg=>bg.addEventListener('click',e=>{ if(e.target===bg) bg.style.display='none'; }));
  });
})();
</script>
</body>
</html>

